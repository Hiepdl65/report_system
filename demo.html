<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiReport - Advanced Report Builder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-border: #334155;
            --light-bg: #f8fafc;
            --light-card: #ffffff;
            --light-border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
        }

        [data-theme="dark"] {
            --bg-color: var(--dark-bg);
            --card-bg: var(--dark-card);
            --border-color: var(--dark-border);
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
        }

        [data-theme="light"] {
            --bg-color: var(--light-bg);
            --card-bg: var(--light-card);
            --border-color: var(--light-border);
            --text-color: var(--text-primary);
            --text-muted: var(--text-secondary);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 280px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-muted);
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Content Area */
        .content {
            flex: 1;
            background: var(--bg-color);
            overflow-y: auto;
        }

        .content-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .content-description {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .content-body {
            padding: 2rem;
        }

        /* Report Builder */
        .builder-container {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 2rem;
            height: 800px;
        }

        .builder-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            color: white;
            padding: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        /* Data Sources */
        .data-source {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .data-source:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            border-color: var(--primary-color);
        }

        .data-source:active {
            cursor: grabbing;
        }

        .data-source-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .data-source-columns {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .column-chip {
            background: var(--border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Canvas */
        .canvas {
            background: linear-gradient(135deg, var(--bg-color) 0%, rgba(37, 99, 235, 0.02) 100%);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .canvas-header {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(37, 99, 235, 0.03) 100%);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 1rem 1rem 0 0;
        }

        .canvas-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .canvas-title i {
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
        }

        .canvas-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            box-shadow: 0 2px 4px rgba(100, 116, 139, 0.2);
        }

        .btn-secondary:hover {
            background: #475569;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: var(--warning-color);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        .btn-warning:hover {
            background: #d97706;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .canvas-content {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 500px;
        }

        .drop-zone {
            border: 3px dashed var(--primary-color);
            border-radius: 1rem;
            padding: 3rem 2rem;
            text-align: center;
            color: var(--primary-color);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .drop-zone:hover::before {
            left: 100%;
        }

        .drop-zone.active {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.15) 0%, rgba(124, 58, 237, 0.15) 100%);
            transform: scale(1.02);
            border-color: #7c3aed;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.2);
        }

        .drop-zone-content {
            position: relative;
            z-index: 2;
        }

        .drop-zone-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
        }

        .drop-zone-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .drop-zone-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .drop-zone-steps {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .drop-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .drop-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .drop-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .drop-step-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            text-align: center;
        }

        .tables-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .tables-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .tables-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .table-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0.5rem;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: all 0.3s ease;
        }

        .table-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .table-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .table-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .table-details h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .table-details p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .remove-table-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-table-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .query-preview {
            background: var(--dark-card);
            color: #a3a3a3;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            position: relative;
            border: 1px solid var(--dark-border);
        }

        .query-editor {
            width: 100%;
            min-height: 200px;
            background: var(--dark-card);
            color: #a3a3a3;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid var(--primary-color);
            resize: vertical;
            outline: none;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        .query-editor:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .query-validation {
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .query-validation.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .query-validation.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        .query-validation.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }

        /* SQL Syntax Highlighting */
        .sql-keyword {
            color: #569cd6;
            font-weight: bold;
        }

        .sql-string {
            color: #ce9178;
        }

        .sql-comment {
            color: #6a9955;
            font-style: italic;
        }

        .sql-function {
            color: #dcdcaa;
        }

        .sql-table {
            color: #4ec9b0;
        }

        .sql-column {
            color: #9cdcfe;
        }

        .sql-operator {
            color: #d4d4d4;
        }

        .sql-number {
            color: #b5cea8;
        }

        .query-changed {
            border-color: var(--warning-color) !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2) !important;
        }

        .query-error {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        }

        /* Configuration Panel */
        .config-section {
            margin: 1rem 0;
        }

        .config-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin: 1rem 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filter-item {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Data Preview Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--card-bg);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:nth-child(even) {
            background: var(--bg-color);
        }

        .data-table tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .slide-in {
            animation: slideUp 0.5s ease;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .builder-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                height: auto;
            }

            .sidebar {
                width: 60px;
            }

            .sidebar .nav-item span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 1rem;
            }

            .content-body {
                padding: 1rem;
            }

            .builder-container {
                grid-template-columns: 1fr;
            }
        }

        /* Success Messages */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #7c3aed);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-chart-bar"></i>
                <span>FlexiReport</span>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <div class="user-info">
                    <div class="avatar">JD</div>
                    <span>John Doe</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="nav-item active" onclick="showSection('builder')">
                <i class="fas fa-tools"></i>
                <span>Report Builder</span>
            </div>
            <div class="nav-item" onclick="showSection('templates')">
                <i class="fas fa-file-alt"></i>
                <span>Templates</span>
            </div>
            <div class="nav-item" onclick="showSection('permissions')">
                <i class="fas fa-shield-alt"></i>
                <span>Permissions</span>
            </div>
            <div class="nav-item" onclick="showSection('exports')">
                <i class="fas fa-download"></i>
                <span>Exports</span>
            </div>
            <div class="nav-item" onclick="showSection('analytics')">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </div>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Report Builder Section -->
            <section id="builder" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">Report Builder</h1>
                    <p class="content-description">Drag and drop to create powerful reports without writing SQL</p>
                </div>
                <div class="content-body">
                    <div class="builder-container">
                        <!-- Data Sources Panel -->
                        <div class="builder-panel">
                            <div class="panel-header">
                                <i class="fas fa-database"></i>
                                Data Sources
                            </div>
                            <div class="panel-content">
                                <div class="data-source" draggable="true" ondragstart="dragStart(event)" data-table="orders">
                                    <div class="data-source-header">
                                        <i class="fas fa-table" style="color: #3b82f6;"></i>
                                        Orders
                                    </div>
                                    <div class="data-source-columns">
                                        <span class="column-chip">id</span>
                                        <span class="column-chip">order_number</span>
                                        <span class="column-chip">customer_id</span>
                                        <span class="column-chip">total_amount</span>
                                        <span class="column-chip">created_at</span>
                                        <span class="column-chip">status</span>
                                    </div>
                                </div>
                                
                                <div class="data-source" draggable="true" ondragstart="dragStart(event)" data-table="customers">
                                    <div class="data-source-header">
                                        <i class="fas fa-users" style="color: #10b981;"></i>
                                        Customers
                                    </div>
                                    <div class="data-source-columns">
                                        <span class="column-chip">id</span>
                                        <span class="column-chip">name</span>
                                        <span class="column-chip">email</span>
                                        <span class="column-chip">phone</span>
                                        <span class="column-chip">address</span>
                                    </div>
                                </div>
                                
                                <div class="data-source" draggable="true" ondragstart="dragStart(event)" data-table="products">
                                    <div class="data-source-header">
                                        <i class="fas fa-box" style="color: #8b5cf6;"></i>
                                        Products
                                    </div>
                                    <div class="data-source-columns">
                                        <span class="column-chip">id</span>
                                        <span class="column-chip">name</span>
                                        <span class="column-chip">sku</span>
                                        <span class="column-chip">price</span>
                                        <span class="column-chip">category_id</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Canvas -->
                        <div class="builder-panel">
                            <div class="panel-header">
                                <i class="fas fa-edit"></i>
                                Report Canvas
                            </div>
                            <div class="canvas">
                                <div class="canvas-header">
                                    <h3>Sales Report</h3>
                                    <div class="canvas-actions">
                                        <button class="btn btn-secondary" onclick="previewReport()">
                                            <i class="fas fa-eye"></i> Preview
                                        </button>
                                        <button class="btn" onclick="saveTemplate()">
                                            <i class="fas fa-save"></i> Save Template
                                        </button>
                                    </div>
                                </div>
                                <div class="canvas-content">
                                    <div id="drop-zone" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                        <p>Drag tables here to start building your report</p>
                                    </div>
                                    
                                    <div id="query-section" style="display: none;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                            <h4>Generated Query Preview:</h4>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <div class="tooltip-container" style="position: relative;">
                                                    <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="showQueryHelp()">
                                                        <i class="fas fa-question-circle"></i>
                                                    </button>
                                                    <div id="query-help" class="tooltip" style="display: none; position: absolute; bottom: 100%; right: 0; background: var(--dark-card); color: white; padding: 1rem; border-radius: 0.5rem; min-width: 300px; font-size: 0.8rem; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                                        <strong>Query Editor Shortcuts:</strong><br>
                                                        <code>Ctrl + E</code> - Toggle edit mode<br>
                                                        <code>Ctrl + Enter</code> - Validate query<br>
                                                        <code>Ctrl + S</code> - Apply changes<br>
                                                        <code>Tab</code> - Add indentation<br>
                                                        <code>Esc</code> - Exit edit mode<br>
                                                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                                                            Auto-complete: <code>(</code> adds closing <code>)</code>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="btn btn-secondary" id="edit-query-btn" onclick="toggleQueryEdit()">
                                                    <i class="fas fa-edit"></i> Edit SQL
                                                </button>
                                                <button class="btn btn-success" id="validate-query-btn" onclick="validateQuery()" style="display: none;">
                                                    <i class="fas fa-check"></i> Validate
                                                </button>
                                                <button class="btn btn-warning" id="revert-query-btn" onclick="revertQuery()" style="display: none;">
                                                    <i class="fas fa-undo"></i> Revert
                                                </button>
                                                <button class="btn" id="apply-query-btn" onclick="applyQuery()" style="display: none;">
                                                    <i class="fas fa-save"></i> Apply Changes
                                                </button>
                                            </div>
                                        </div>
                                        <div class="query-preview" id="query-preview">
                                            -- Query will appear here
                                        </div>
                                        <textarea class="query-editor" id="query-editor" style="display: none;"></textarea>
                                        <div id="query-validation" class="query-validation" style="display: none;"></div>
                                    </div>
                                    
                                    <div id="data-preview" style="display: none;">
                                        <h4>Data Preview:</h4>
                                        <table class="data-table" id="preview-table">
                                            <thead></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Panel -->
                        <div class="builder-panel">
                            <div class="panel-header">
                                <i class="fas fa-cog"></i>
                                Configuration
                            </div>
                            <div class="panel-content">
                                <div class="config-section">
                                    <div class="config-title">
                                        <i class="fas fa-columns"></i>
                                        Columns
                                    </div>
                                    <div id="columns-config">
                                        <p class="text-muted">Select tables first to configure columns</p>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <div class="config-title">
                                        <i class="fas fa-filter"></i>
                                        Filters
                                    </div>
                                    <div id="filters-config">
                                        <button class="btn btn-secondary" onclick="addFilter()">
                                            <i class="fas fa-plus"></i> Add Filter
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <div class="config-title">
                                        <i class="fas fa-sort"></i>
                                        Sorting
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Sort By</label>
                                        <select class="form-select" id="sort-column">
                                            <option value="">Select column...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Direction</label>
                                        <select class="form-select" id="sort-direction">
                                            <option value="ASC">Ascending</option>
                                            <option value="DESC">Descending</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <div class="config-title">
                                        <i class="fas fa-list-ol"></i>
                                        Pagination
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Records Per Page</label>
                                        <select class="form-select" id="page-size">
                                            <option value="10">10</option>
                                            <option value="25" selected>25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Templates Section -->
            <section id="templates" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Template Manager</h1>
                    <p class="content-description">Manage and share report templates</p>
                </div>
                <div class="content-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <div class="builder-panel">
                            <div class="panel-content">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), #7c3aed); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-chart-bar text-white"></i>
                                    </div>
                                    <div>
                                        <h3>Sales Report</h3>
                                        <p class="text-muted">Monthly sales analysis</p>
                                    </div>
                                </div>
                                <div class="progress-bar" style="margin: 1rem 0;">
                                    <div class="progress-fill" style="width: 85%;"></div>
                                </div>
                                <div style="display: flex; justify-content: between; align-items: center; margin-top: 1rem;">
                                    <small class="text-muted">Last used: 2 days ago</small>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="builder-panel">
                            <div class="panel-content">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--success-color), #16a34a); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-boxes text-white"></i>
                                    </div>
                                    <div>
                                        <h3>Inventory Report</h3>
                                        <p class="text-muted">Stock levels and trends</p>
                                    </div>
                                </div>
                                <div class="progress-bar" style="margin: 1rem 0;">
                                    <div class="progress-fill" style="width: 92%;"></div>
                                </div>
                                <div style="display: flex; justify-content: between; align-items: center; margin-top: 1rem;">
                                    <small class="text-muted">Last used: 1 week ago</small>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="builder-panel">
                            <div class="panel-content">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--warning-color), #f97316); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-users text-white"></i>
                                    </div>
                                    <div>
                                        <h3>Customer Analysis</h3>
                                        <p class="text-muted">Customer behavior insights</p>
                                    </div>
                                </div>
                                <div class="progress-bar" style="margin: 1rem 0;">
                                    <div class="progress-fill" style="width: 78%;"></div>
                                </div>
                                <div style="display: flex; justify-content: between; align-items: center; margin-top: 1rem;">
                                    <small class="text-muted">Last used: 3 days ago</small>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Permissions Section -->
            <section id="permissions" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Permission Management</h1>
                    <p class="content-description">Control access to templates and reports</p>
                </div>
                <div class="content-body">
                    <div class="builder-panel">
                        <div class="panel-header">
                            <i class="fas fa-shield-alt"></i>
                            Template Permissions
                        </div>
                        <div class="panel-content">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Template</th>
                                        <th>User/Role</th>
                                        <th>Permission</th>
                                        <th>Granted By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Sales Report</td>
                                        <td>John Smith</td>
                                        <td><span class="badge badge-success">Execute</span></td>
                                        <td>Admin</td>
                                        <td>
                                            <button class="btn btn-warning">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Inventory Report</td>
                                        <td>Sales Team</td>
                                        <td><span class="badge badge-info">View</span></td>
                                        <td>Manager</td>
                                        <td>
                                            <button class="btn btn-warning">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Exports Section -->
            <section id="exports" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Export History</h1>
                    <p class="content-description">Track and download exported reports</p>
                </div>
                <div class="content-body">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        Sales Report exported successfully! Click to download.
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Report</th>
                                <th>Format</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Sales Report - March 2024</td>
                                <td>Excel</td>
                                <td><span class="alert-success" style="padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.8rem;">Completed</span></td>
                                <td>2024-03-15 10:30</td>
                                <td>2.4 MB</td>
                                <td>
                                    <button class="btn btn-success">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Customer Analysis</td>
                                <td>PDF</td>
                                <td><span class="alert-warning" style="padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.8rem;">Processing</span></td>
                                <td>2024-03-15 09:45</td>
                                <td>-</td>
                                <td>
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Analytics Dashboard</h1>
                    <p class="content-description">Usage insights and performance metrics</p>
                </div>
                <div class="content-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="builder-panel">
                            <div class="panel-content" style="text-align: center;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem;">147</div>
                                <div>Total Reports Generated</div>
                                <div style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-up" style="color: var(--success-color);"></i>
                                    <span style="color: var(--success-color);">+12%</span>
                                    <span class="text-muted">vs last month</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="builder-panel">
                            <div class="panel-content" style="text-align: center;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--success-color); margin-bottom: 0.5rem;">23</div>
                                <div>Active Templates</div>
                                <div style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-up" style="color: var(--success-color);"></i>
                                    <span style="color: var(--success-color);">+3</span>
                                    <span class="text-muted">new this month</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="builder-panel">
                            <div class="panel-content" style="text-align: center;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning-color); margin-bottom: 0.5rem;">1.2s</div>
                                <div>Avg. Query Time</div>
                                <div style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-down" style="color: var(--success-color);"></i>
                                    <span style="color: var(--success-color);">-15%</span>
                                    <span class="text-muted">faster</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="builder-panel">
                            <div class="panel-content" style="text-align: center;">
                                <div style="font-size: 2.5rem; font-weight: 700; color: var(--danger-color); margin-bottom: 0.5rem;">42</div>
                                <div>Active Users</div>
                                <div style="margin-top: 1rem;">
                                    <i class="fas fa-arrow-up" style="color: var(--success-color);"></i>
                                    <span style="color: var(--success-color);">+5</span>
                                    <span class="text-muted">this week</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="builder-panel">
                        <div class="panel-header">
                            <i class="fas fa-chart-line"></i>
                            Usage Trends
                        </div>
                        <div class="panel-content">
                            <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                <div style="text-align: center;">
                                    <i class="fas fa-chart-area fa-3x" style="margin-bottom: 1rem;"></i>
                                    <p>Interactive charts would be rendered here using Chart.js or D3.js</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Save Template Modal -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1.5rem;">Save Report Template</h2>
            <div class="form-group">
                <label class="form-label">Template Name</label>
                <input type="text" class="form-input" id="template-name" placeholder="Enter template name..." value="Sales Report">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="template-description" rows="3" placeholder="Describe this template...">Monthly sales analysis with customer breakdown</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Tags</label>
                <input type="text" class="form-input" id="template-tags" placeholder="sales, monthly, revenue" value="sales, monthly, revenue">
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeSaveModal()">Cancel</button>
                <button class="btn" onclick="confirmSaveTemplate()">
                    <i class="fas fa-save"></i> Save Template
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTables = [];
        let currentColumns = [];
        let originalQuery = '';
        let isQueryEditing = false;
        let reportConfig = {
            version: "1.0",
            metadata: { name: "", description: "", tags: [] },
            dataSources: [],
            columns: [],
            filters: [],
            orderBy: [],
            pagination: { enabled: true, limit: 25 }
        };

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.getAttribute('data-theme') === 'light') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
            } else {
                body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon';
            }
        }

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            var sections = document.querySelectorAll('.content-section');
            for (var i = 0; i < sections.length; i++) {
                sections[i].style.display = 'none';
            }
            
            // Remove active class from nav items
            var navItems = document.querySelectorAll('.nav-item');
            for (var i = 0; i < navItems.length; i++) {
                navItems[i].classList.remove('active');
            }
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Add active class to clicked nav item
            event.target.closest('.nav-item').classList.add('active');
        }

        // Drag and Drop functionality
        function dragStart(event) {
            event.dataTransfer.setData("text/plain", event.target.dataset.table);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dragEnter(event) {
            event.preventDefault();
            document.getElementById('drop-zone').classList.add('active');
        }

        function dragLeave(event) {
            event.preventDefault();
            document.getElementById('drop-zone').classList.remove('active');
        }

        function drop(event) {
            event.preventDefault();
            var tableName = event.dataTransfer.getData("text/plain");
            
            if (currentTables.indexOf(tableName) === -1) {
                addTableToReport(tableName);
            }
            
            document.getElementById('drop-zone').classList.remove('active');
            updateDropZone();
            generateQuery();
        }

        function addTableToReport(tableName) {
            currentTables.push(tableName);
            
            // Add to report config
            var tableConfig = {
                alias: tableName,
                table: tableName,
                joins: []
            };
            
            // Auto-detect joins (simplified logic)
            if (currentTables.length > 1) {
                if (tableName === 'customers' && currentTables.indexOf('orders') !== -1) {
                    tableConfig.joins.push({
                        table: 'customers',
                        alias: 'customers',
                        type: 'LEFT',
                        on: 'orders.customer_id = customers.id'
                    });
                }
            }
            
            reportConfig.dataSources.push(tableConfig);
            updateColumnsConfig();
        }

        function updateDropZone() {
            const dropZone = document.getElementById('drop-zone');
            if (currentTables.length > 0) {
                var tablesHtml = '';
                currentTables.forEach(function(table) {
                    tablesHtml += 
                        '<div style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">' +
                            '<i class="fas fa-table"></i>' +
                            table +
                            '<button onclick="removeTable(\'' + table + '\')" style="background: none; border: none; color: white; cursor: pointer;">' +
                                '<i class="fas fa-times"></i>' +
                            '</button>' +
                        '</div>';
                });
                
                dropZone.innerHTML = 
                    '<div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">' +
                        tablesHtml +
                    '</div>' +
                    '<p style="margin-top: 1rem; color: var(--text-muted);">Tables added successfully. Configure columns and filters in the right panel.</p>';
            }
        }

        function removeTable(tableName) {
            currentTables = currentTables.filter(function(table) { 
                return table !== tableName; 
            });
            reportConfig.dataSources = reportConfig.dataSources.filter(function(ds) { 
                return ds.table !== tableName; 
            });
            updateDropZone();
            updateColumnsConfig();
            generateQuery();
        }

        function updateColumnsConfig() {
            const columnsConfig = document.getElementById('columns-config');
            const tableColumns = {
                orders: ['id', 'order_number', 'customer_id', 'total_amount', 'created_at', 'status'],
                customers: ['id', 'name', 'email', 'phone', 'address'],
                products: ['id', 'name', 'sku', 'price', 'category_id']
            };
            
            if (currentTables.length === 0) {
                columnsConfig.innerHTML = '<p class="text-muted">Select tables first to configure columns</p>';
                return;
            }
            
            var html = '';
            currentTables.forEach(function(table) {
                html += '<div class="config-subsection">';
                html += '<h5 style="margin: 1rem 0 0.5rem 0; color: var(--primary-color);">' + table + '</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';
                
                if (tableColumns[table]) {
                    tableColumns[table].forEach(function(column) {
                        var isChecked = currentColumns.some(function(col) { 
                            return col.field === table + '.' + column; 
                        });
                        html += 
                            '<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-color); border-radius: 0.25rem;">' +
                                '<input type="checkbox" onchange="toggleColumn(\'' + table + '\', \'' + column + '\')"' + (isChecked ? ' checked' : '') + '>' +
                                '<span>' + column + '</span>' +
                            '</label>';
                    });
                }
                
                html += '</div></div>';
            });
            
            columnsConfig.innerHTML = html;
            
            // Update sort options
            const sortColumn = document.getElementById('sort-column');
            sortColumn.innerHTML = '<option value="">Select column...</option>';
            currentColumns.forEach(function(col) {
                sortColumn.innerHTML += '<option value="' + col.field + '">' + col.alias + '</option>';
            });
        }

        function toggleColumn(table, column) {
            var field = table + '.' + column;
            var existingIndex = -1;
            
            for (var i = 0; i < currentColumns.length; i++) {
                if (currentColumns[i].field === field) {
                    existingIndex = i;
                    break;
                }
            }
            
            if (existingIndex >= 0) {
                currentColumns.splice(existingIndex, 1);
            } else {
                currentColumns.push({
                    field: field,
                    alias: column.charAt(0).toUpperCase() + column.slice(1).replace('_', ' '),
                    type: 'string'
                });
            }
            
            reportConfig.columns = currentColumns;
            generateQuery();
        }

        function generateQuery() {
            if (currentTables.length === 0 || currentColumns.length === 0) {
                document.getElementById('query-section').style.display = 'none';
                return;
            }
            
            const selectClause = currentColumns.map(function(col) { 
                return col.field + ' AS "' + col.alias + '"'; 
            }).join(',\n    ');
            const fromClause = currentTables[0];
            let joinClause = '';
            
            // Simple join logic
            if (currentTables.indexOf('orders') !== -1 && currentTables.indexOf('customers') !== -1) {
                joinClause += '\nLEFT JOIN customers ON orders.customer_id = customers.id';
            }
            
            const query = 'SELECT \n    ' + selectClause + '\nFROM ' + fromClause + joinClause + '\nWHERE 1=1\nORDER BY ' + currentTables[0] + '.id DESC\nLIMIT 25;';
            
            originalQuery = query;
            const highlightedQuery = highlightSQLSyntax(query);
            document.getElementById('query-preview').innerHTML = highlightedQuery;
            document.getElementById('query-editor').value = query;
            document.getElementById('query-section').style.display = 'block';
            
            // Reset editing state
            if (isQueryEditing) {
                exitQueryEdit();
            }
        }

        // SQL Syntax Highlighting
        function highlightSQLSyntax(sql) {
            const keywords = ['SELECT', 'FROM', 'WHERE', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'OUTER', 
                            'ON', 'AS', 'ORDER', 'BY', 'GROUP', 'HAVING', 'LIMIT', 'OFFSET', 
                            'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'BETWEEN', 'LIKE', 'IS', 'NULL'];
            
            const functions = ['SUM', 'COUNT', 'AVG', 'MIN', 'MAX', 'DATE_FORMAT', 'CONCAT', 
                             'SUBSTRING', 'UPPER', 'LOWER', 'TRIM'];
            
            let highlighted = sql;
            
            // Highlight keywords
            keywords.forEach(keyword => {
                const regex = new RegExp('\\b' + keyword + '\\b', 'gi');
                highlighted = highlighted.replace(regex, '<span class="sql-keyword">' + keyword.toUpperCase() + '</span>');
            });
            
            // Highlight functions
            functions.forEach(func => {
                const regex = new RegExp('\\b' + func + '\\s*\\(', 'gi');
                highlighted = highlighted.replace(regex, function(match) {
                    return '<span class="sql-function">' + match.slice(0, -1) + '</span>(';
                });
            });
            
            // Highlight strings
            highlighted = highlighted.replace(/'([^']*)'/g, '<span class="sql-string">\'$1\'</span>');
            highlighted = highlighted.replace(/"([^"]*)"/g, '<span class="sql-string">"$1"</span>');
            
            // Highlight comments
            highlighted = highlighted.replace(/--.*$/gm, '<span class="sql-comment">        function generateQuery() {
            if (currentTables.length === 0 || currentColumns.length === 0) {
                document.getElementById('query-section').style.display = 'none';
                return;
            }
            
            const selectClause = currentColumns.map(col => `${col.field} AS "${col.alias}"`).join(',\n    ');
            const fromClause = currentTables[0];
            let joinClause = '';
            
            // Simple join logic
            if (currentTables.includes('orders') && currentTables.includes('customers')) {
                joinClause += '\nLEFT JOIN customers ON orders.customer_id = customers.id';
            }
            
            const query = `SELECT 
    ${selectClause}
FROM ${fromClause}${joinClause}
WHERE 1=1
ORDER BY ${currentTables[0]}.id DESC
LIMIT 25;`;
            
            document.getElementById('query-preview').textContent = query;
            document.getElementById('query-section').style.display = 'block';
        }</span>');
            
            // Highlight numbers
            highlighted = highlighted.replace(/\b\d+\.?\d*\b/g, '<span class="sql-number">        function generateQuery() {
            if (currentTables.length === 0 || currentColumns.length === 0) {
                document.getElementById('query-section').style.display = 'none';
                return;
            }
            
            const selectClause = currentColumns.map(col => `${col.field} AS "${col.alias}"`).join(',\n    ');
            const fromClause = currentTables[0];
            let joinClause = '';
            
            // Simple join logic
            if (currentTables.includes('orders') && currentTables.includes('customers')) {
                joinClause += '\nLEFT JOIN customers ON orders.customer_id = customers.id';
            }
            
            const query = `SELECT 
    ${selectClause}
FROM ${fromClause}${joinClause}
WHERE 1=1
ORDER BY ${currentTables[0]}.id DESC
LIMIT 25;`;
            
            document.getElementById('query-preview').textContent = query;
            document.getElementById('query-section').style.display = 'block';
        }</span>');
            
            // Highlight table names (simple detection)
            const tableNames = ['orders', 'customers', 'products', 'categories', 'suppliers'];
            tableNames.forEach(table => {
                const regex = new RegExp('\\b' + table + '\\b(?!\\s*\\()', 'gi');
                highlighted = highlighted.replace(regex, '<span class="sql-table">' + table + '</span>');
            });
            
            return highlighted;
        }

        // Query Editing Functions
        function toggleQueryEdit() {
            if (!isQueryEditing) {
                enterQueryEdit();
            } else {
                exitQueryEdit();
            }
        }

        function enterQueryEdit() {
            isQueryEditing = true;
            
            // Show editor, hide preview
            document.getElementById('query-preview').style.display = 'none';
            document.getElementById('query-editor').style.display = 'block';
            document.getElementById('query-editor').value = originalQuery;
            
            // Update buttons
            document.getElementById('edit-query-btn').innerHTML = '<i class="fas fa-eye"></i> View Preview';
            document.getElementById('validate-query-btn').style.display = 'inline-flex';
            document.getElementById('revert-query-btn').style.display = 'inline-flex';
            document.getElementById('apply-query-btn').style.display = 'inline-flex';
            
            // Focus editor
            document.getElementById('query-editor').focus();
            
            // Add change listener
            document.getElementById('query-editor').addEventListener('input', onQueryChange);
        }

        function exitQueryEdit() {
            isQueryEditing = false;
            
            // Show preview, hide editor
            document.getElementById('query-preview').style.display = 'block';
            document.getElementById('query-editor').style.display = 'none';
            
            // Update buttons
            document.getElementById('edit-query-btn').innerHTML = '<i class="fas fa-edit"></i> Edit SQL';
            document.getElementById('validate-query-btn').style.display = 'none';
            document.getElementById('revert-query-btn').style.display = 'none';
            document.getElementById('apply-query-btn').style.display = 'none';
            
            // Clear validation
            document.getElementById('query-validation').style.display = 'none';
            document.getElementById('query-editor').classList.remove('query-changed', 'query-error');
            
            // Remove change listener
            document.getElementById('query-editor').removeEventListener('input', onQueryChange);
        }

        function onQueryChange() {
            const currentQuery = document.getElementById('query-editor').value;
            const hasChanges = currentQuery !== originalQuery;
            
            if (hasChanges) {
                document.getElementById('query-editor').classList.add('query-changed');
                document.getElementById('apply-query-btn').style.background = '#f59e0b';
            } else {
                document.getElementById('query-editor').classList.remove('query-changed');
                document.getElementById('apply-query-btn').style.background = '#2563eb';
            }
            
            // Clear previous validation
            document.getElementById('query-validation').style.display = 'none';
            document.getElementById('query-editor').classList.remove('query-error');
        }

        function validateQuery() {
            const query = document.getElementById('query-editor').value;
            const validation = document.getElementById('query-validation');
            
            // Simple SQL validation (in real app, this would be server-side)
            const validationResult = performSQLValidation(query);
            
            validation.style.display = 'block';
            validation.className = `query-validation ${validationResult.type}`;
            validation.innerHTML = 
                '<div style="display: flex; align-items: center; gap: 0.5rem;">' +
                    '<i class="fas fa-' + validationResult.icon + '"></i>' +
                    '<strong>' + validationResult.title + '</strong>' +
                '</div>' +
                validationResult.message +
                (validationResult.suggestions ? 
                    '<div style="margin-top: 0.5rem;"><strong>Suggestions:</strong><ul>' + 
                    validationResult.suggestions.map(s => '<li>' + s + '</li>').join('') + 
                    '</ul></div>' : '');
            
            if (validationResult.type === 'error') {
                document.getElementById('query-editor').classList.add('query-error');
            } else {
                document.getElementById('query-editor').classList.remove('query-error');
            }
        }

        function performSQLValidation(query) {
            const errors = [];
            const warnings = [];
            const suggestions = [];
            
            // Basic syntax checks
            const trimmedQuery = query.trim().toUpperCase();
            
            if (!trimmedQuery.startsWith('SELECT')) {
                errors.push('Query must start with SELECT statement');
            }
            
            if (!trimmedQuery.includes('FROM')) {
                errors.push('Query must include FROM clause');
            }
            
            // Check for common SQL injection patterns (basic)
            const dangerousPatterns = [/';?\s*DROP\s+/i, /';?\s*DELETE\s+/i, /';?\s*INSERT\s+/i, /';?\s*UPDATE\s+/i];
            dangerousPatterns.forEach(pattern => {
                if (pattern.test(query)) {
                    errors.push('Potentially dangerous SQL pattern detected');
                }
            });
            
            // Check for performance issues
            if (!trimmedQuery.includes('LIMIT')) {
                warnings.push('Consider adding LIMIT clause for better performance');
                suggestions.push('Add LIMIT clause to restrict result set size');
            }
            
            if (trimmedQuery.includes('SELECT *')) {
                warnings.push('Avoid SELECT * for better performance');
                suggestions.push('Specify exact columns instead of using SELECT *');
            }
            
            // Check brackets balance
            const openBrackets = (query.match(/\(/g) || []).length;
            const closeBrackets = (query.match(/\)/g) || []).length;
            if (openBrackets !== closeBrackets) {
                errors.push('Unbalanced parentheses in query');
            }
            
            // Return validation result
            if (errors.length > 0) {
                return {
                    type: 'error',
                    icon: 'exclamation-triangle',
                    title: 'Validation Failed',
                    message: '<div style="margin-top: 0.5rem;"><strong>Errors:</strong><ul>' + errors.map(e => '<li>' + e + '</li>').join('') + '</ul></div>',
                    suggestions: suggestions.length > 0 ? suggestions : null
                };
            } else if (warnings.length > 0) {
                return {
                    type: 'warning',
                    icon: 'exclamation-circle',
                    title: 'Validation Passed with Warnings',
                    message: '<div style="margin-top: 0.5rem;"><strong>Warnings:</strong><ul>' + warnings.map(w => '<li>' + w + '</li>').join('') + '</ul></div>',
                    suggestions: suggestions.length > 0 ? suggestions : null
                };
            } else {
                return {
                    type: 'success',
                    icon: 'check-circle',
                    title: 'Validation Passed',
                    message: '<div style="margin-top: 0.5rem;">Query looks good! No issues detected.</div>'
                };
            }
        }

        function revertQuery() {
            if (confirm('Are you sure you want to revert all changes?')) {
                document.getElementById('query-editor').value = originalQuery;
                document.getElementById('query-editor').classList.remove('query-changed', 'query-error');
                document.getElementById('query-validation').style.display = 'none';
                document.getElementById('apply-query-btn').style.background = var(--primary-color);
            }
        }

        function applyQuery() {
            const newQuery = document.getElementById('query-editor').value;
            
            // Validate before applying
            const validationResult = performSQLValidation(newQuery);
            if (validationResult.type === 'error') {
                alert('Please fix validation errors before applying changes.');
                validateQuery();
                return;
            }
            
            // Confirm apply with warnings
            if (validationResult.type === 'warning') {
                if (!confirm('Query has warnings. Are you sure you want to apply these changes?')) {
                    return;
                }
            }
            
            // Apply changes
            originalQuery = newQuery;
            const highlightedQuery = highlightSQLSyntax(newQuery);
            document.getElementById('query-preview').innerHTML = highlightedQuery;
            
            // Try to parse query back to visual config (simplified)
            try {
                parseQueryToConfig(newQuery);
            } catch (error) {
                console.warn('Could not parse query back to visual config:', error);
            }
            
            // Exit edit mode
            exitQueryEdit();
            
            // Show success message
            showNotification('Query applied successfully!', 'success');
            
            // Update preview
            previewReport();
        }

        function parseQueryToConfig(query) {
            // This is a simplified parser - in reality, you'd use a proper SQL parser
            const upperQuery = query.toUpperCase();
            
            // Extract table names from FROM and JOIN clauses
            const fromMatch = query.match(/FROM\s+(\w+)/i);
            const joinMatches = [...query.matchAll(/JOIN\s+(\w+)/gi)];
            
            if (fromMatch) {
                const mainTable = fromMatch[1].toLowerCase();
                if (!currentTables.includes(mainTable)) {
                    currentTables.push(mainTable);
                }
            }
            
            joinMatches.forEach(match => {
                const joinTable = match[1].toLowerCase();
                if (!currentTables.includes(joinTable)) {
                    currentTables.push(joinTable);
                }
            });
            
            // Update visual config
            updateDropZone();
            updateColumnsConfig();
        }

        function showNotification(message, type) {
            if (type === undefined) type = 'info';
            
            var iconClass = 'info-circle';
            if (type === 'success') iconClass = 'check-circle';
            if (type === 'warning') iconClass = 'exclamation-triangle';
            
            const notification = document.createElement('div');
            notification.className = 'alert alert-' + type + ' fade-in';
            notification.innerHTML = 
                '<i class="fas fa-' + iconClass + '"></i>' +
                message +
                '<button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;">' +
                    '<i class="fas fa-times"></i>' +
                '</button>';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.gap = '0.5rem';
            
            const contentBody = document.querySelector('#builder .content-body');
            contentBody.insertBefore(notification, contentBody.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showQueryHelp() {
            const tooltip = document.getElementById('query-help');
            tooltip.style.display = tooltip.style.display === 'none' ? 'block' : 'none';
            
            // Hide tooltip when clicking outside
            if (tooltip.style.display === 'block') {
                setTimeout(() => {
                    const clickHandler = (e) => {
                        if (!tooltip.contains(e.target) && !e.target.closest('.tooltip-container')) {
                            tooltip.style.display = 'none';
                            document.removeEventListener('click', clickHandler);
                        }
                    };
                    document.addEventListener('click', clickHandler);
                }, 100);
            }
        }

        // Enhanced query formatting
        function formatSQL(query) {
            return query
                .replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|ORDER|BY|GROUP|HAVING|LIMIT)\b/gi, '\n$1')
                .replace(/,/g, ',\n    ')
                .replace(/\n\s*\n/g, '\n')
                .trim();
        }

        // Add line numbers to query editor
        function addLineNumbers() {
            const editor = document.getElementById('query-editor');
            const lines = editor.value.split('\n');
            const lineCount = lines.length;
            
            // This is a simplified implementation - in production, you'd use a proper code editor
            console.log(`Query has ${lineCount} lines`);
        }

        function addFilter() {
            const filtersConfig = document.getElementById('filters-config');
            const filterId = Date.now();
            
            var columnsOptions = '<option value="">Select column...</option>';
            currentColumns.forEach(function(col) {
                columnsOptions += '<option value="' + col.field + '">' + col.alias + '</option>';
            });
            
            const filterHtml = 
                '<div class="filter-item" id="filter-' + filterId + '">' +
                    '<select class="form-select" style="flex: 1;">' +
                        columnsOptions +
                    '</select>' +
                    '<select class="form-select" style="flex: 0.5;">' +
                        '<option value="eq">Equals</option>' +
                        '<option value="ne">Not Equals</option>' +
                        '<option value="gt">Greater Than</option>' +
                        '<option value="lt">Less Than</option>' +
                        '<option value="like">Contains</option>' +
                    '</select>' +
                    '<input type="text" class="form-input" placeholder="Value..." style="flex: 1;">' +
                    '<button class="btn btn-danger" onclick="removeFilter(' + filterId + ')" style="flex: none;">' +
                        '<i class="fas fa-trash"></i>' +
                    '</button>' +
                '</div>';
            
            filtersConfig.insertAdjacentHTML('beforeend', filterHtml);
        }

        function removeFilter(filterId) {
            document.getElementById('filter-' + filterId).remove();
        }

        function previewReport() {
            if (currentTables.length === 0) {
                alert('Please select at least one table first.');
                return;
            }
            
            // Show loading
            var previewDiv = document.getElementById('data-preview');
            previewDiv.style.display = 'block';
            previewDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading preview...</p></div>';
            
            // Simulate API call
            setTimeout(function() {
                var sampleData = [
                    { 'Order Number': 'ORD-001', 'Customer Name': 'John Smith', 'Total Amount': '$1,250.00', 'Status': 'Completed' },
                    { 'Order Number': 'ORD-002', 'Customer Name': 'Sarah Johnson', 'Total Amount': '$850.50', 'Status': 'Processing' },
                    { 'Order Number': 'ORD-003', 'Customer Name': 'Mike Davis', 'Total Amount': '$2,100.75', 'Status': 'Shipped' },
                    { 'Order Number': 'ORD-004', 'Customer Name': 'Lisa Wilson', 'Total Amount': '$450.25', 'Status': 'Pending' },
                    { 'Order Number': 'ORD-005', 'Customer Name': 'David Brown', 'Total Amount': '$1,750.00', 'Status': 'Completed' }
                ];
                
                var table = document.getElementById('preview-table');
                var headers = Object.keys(sampleData[0]);
                
                var headerHtml = '<tr>';
                for (var i = 0; i < headers.length; i++) {
                    headerHtml += '<th>' + headers[i] + '</th>';
                }
                headerHtml += '</tr>';
                table.querySelector('thead').innerHTML = headerHtml;
                
                var bodyHtml = '';
                for (var i = 0; i < sampleData.length; i++) {
                    bodyHtml += '<tr>';
                    for (var j = 0; j < headers.length; j++) {
                        bodyHtml += '<td>' + sampleData[i][headers[j]] + '</td>';
                    }
                    bodyHtml += '</tr>';
                }
                table.querySelector('tbody').innerHTML = bodyHtml;
                
                previewDiv.innerHTML = '<h4>Data Preview:</h4>';
                previewDiv.appendChild(table);
            }, 1500);
        }

        function saveTemplate() {
            document.getElementById('saveModal').classList.add('show');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('show');
        }

        function confirmSaveTemplate() {
            const name = document.getElementById('template-name').value;
            const description = document.getElementById('template-description').value;
            const tags = document.getElementById('template-tags').value.split(',').map(tag => tag.trim());
            
            if (!name) {
                alert('Please enter a template name.');
                return;
            }
            
            // Update report config
            reportConfig.metadata = { name, description, tags };
            
            // Simulate save
            closeSaveModal();
            
            // Show success message
            const contentBody = document.querySelector('#builder .content-body');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success fade-in';
            successAlert.innerHTML = `
                <i class="fas fa-check-circle"></i>
                Template "${name}" saved successfully! You can now find it in the Templates section.
            `;
            contentBody.insertBefore(successAlert, contentBody.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                successAlert.remove();
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial theme based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }
            
            // Add some initial animation
            document.querySelector('.main-container').classList.add('fade-in');
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            var modal = document.getElementById('saveModal');
            if (event.target === modal) {
                closeSaveModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Query editor specific shortcuts
            if (isQueryEditing && document.getElementById('query-editor') === document.activeElement) {
                if (event.ctrlKey || event.metaKey) {
                    switch(event.key) {
                        case 'Enter':
                            event.preventDefault();
                            validateQuery();
                            break;
                        case 's':
                            event.preventDefault();
                            applyQuery();
                            break;
                        case 'z':
                            if (event.shiftKey) {
                                event.preventDefault();
                                // Redo functionality could be added here
                            }
                            break;
                    }
                }
                
                // Tab for indentation
                if (event.key === 'Tab') {
                    event.preventDefault();
                    const editor = document.getElementById('query-editor');
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 4;
                    onQueryChange();
                }
                
                // Auto-complete brackets
                if (event.key === '(' && !event.ctrlKey && !event.metaKey) {
                    event.preventDefault();
                    const editor = document.getElementById('query-editor');
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + '()' + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 1;
                    onQueryChange();
                }
                
                return;
            }
            
            // Global shortcuts
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 's':
                        event.preventDefault();
                        if (currentTables.length > 0) {
                            saveTemplate();
                        }
                        break;
                    case 'p':
                        event.preventDefault();
                        previewReport();
                        break;
                    case 'e':
                        event.preventDefault();
                        if (document.getElementById('query-section').style.display !== 'none') {
                            toggleQueryEdit();
                        }
                        break;
                }
            }
            
            if (event.key === 'Escape') {
                closeSaveModal();
                if (isQueryEditing) {
                    exitQueryEdit();
                }
            }
        });
    </script>
</body>
</html>